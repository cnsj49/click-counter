name: Helm-Lab

on:
  workflow_dispatch:
  push:
    branches:
      - helm

jobs:

  prepare:
    runs-on: lab
    steps:
      - name: Set Tag on Workflow Dispatch
        run: echo "IMAGE_TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV

  build:
    runs-on: lab
    needs: prepare
    environment: helm
    steps:
      - name: clean
        run: rm -rf click-counter
      - name: git checkout
        run: git clone -b helm https://github.com/cnsj49/click-counter.git

      - name: docker login
        run: |
          echo ${{ secrets.DOCKER_REGISTRY }}
          docker login -u chanut995953 -p ${{ secrets.DOCKER_REGISTRY }}
        
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
